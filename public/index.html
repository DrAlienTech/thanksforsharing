<!DOCTYPE html>
<html>
  <head>
    <title>Thx 4 Sharing</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link type="text/javascript"

    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <script src="/__/firebase/7.6.1/firebase-app.js"></script>
    <script src="/__/firebase/7.6.1/firebase-auth.js"></script>
    <script src="/__/firebase/7.6.1/firebase-database.js"></script>
    <script src="/__/firebase/7.6.1/firebase-messaging.js"></script>
    <script src="/__/firebase/7.6.1/firebase-storage.js"></script>
    <script src="/__/firebase/7.6.1/firebase-analytics.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script>
      var user = firebase.auth().currentUser;
      var db = firebase.firestore();
      db.enablePersistence()

      function redirect(pagePath) {
        if (pagePath === "signout") {
          firebase.auth().signOut();
          window.location.replace("https://www.thx4sharing.web.app");
        } else {
          var urlParams = new URLSearchParams(window.location.search);
          var mode = urlParams.get('mode').toString();
          window.location = pagePath + "?mode=" + mode;
        };
      };

      window.onload = function () {
        var urlParams = new URLSearchParams(window.location.search);
        var mode = urlParams.get("darkmode");
        if (mode == "dark") {
          document.getElementByTagName("html").id = "dark";
        }
      };

      function toggleSignIn() {
        if (!firebase.auth().currentUser) {
          var provider = new firebase.auth.GoogleAuthProvider();

          firebase.auth().signInWithPopup(provider).then(function (result) {
            var token = result.credential.accessToken;
            var user = result.user;
            var uid = user.uid.toString();
            var db = firebase.firestore();
            var emails = db.collection("emails");
            var users = db.collection("users");

            firebase.auth().onAuthStateChanged(function (user) {
              if (user != null) {
                var user = firebase.auth().currentUser;

                user.providerData.forEach(function (profile) {
                  var username = profile.displayName.toString();
                  var email = profile.email.toString();
                  var userDataEmails = emails.doc(username);
                  var userDataUsers = users.doc(uid);

                  userDataEmails.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataEmails.set({
                        email: email,
                        uid: uid,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Emails doc already exists, skipped writing.");
                    }
                  });

                  userDataUsers.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataUsers.set({
                        displayName: username,
                        email: email,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Users doc already exists, skipped writing.");
                    }
                  });
                  window.location = "home.html?mode=light";
                });
              }
            })
          }).catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
            var email = error.email;
            var credential = error.credential;
            if (errorCode === 'auth/account-exists-with-different-credential') {
              alert('You have already signed up with a different method for that email. If you want to merge your Google account with an Email/Password account, go to the Account page.');
            } else {
              console.error(error);
            }
          });
        } else {
          firebase.auth().signOut();
          var provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().signInWithPopup(provider).then(function (result) {
            var token = result.credential.accessToken;
            var user = result.user;
            var uid = user.uid.toString();
            var db = firebase.firestore();
            var emails = db.collection("emails");
            var users = db.collection("users");

            firebase.auth().onAuthStateChanged(function (user) {
              if (user != null) {
                var user = firebase.auth().currentUser;

                user.providerData.forEach(function (profile) {
                  var username = profile.displayName.toString();
                  var email = profile.email.toString();
                  var userDataEmails = emails.doc(username);
                  var userDataUsers = users.doc(uid);

                  userDataEmails.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataEmails.set({
                        email: email,
                        uid: uid,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Emails doc already exists, skipped writing.");
                    }
                  });

                  userDataUsers.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataUsers.set({
                        displayName: username,
                        email: email,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Users doc already exists, skipped writing.");
                    }
                  });
                  window.location = "home.html?mode=light";
                });
              }
            })
          }).catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
            var email = error.email;
            var credential = error.credential;
            if (errorCode === 'auth/account-exists-with-different-credential') {
              alert('You have already signed up with a different method for that email. If you want to merge your Google account with an Email/Password account, go to the Account page.');
            } else {
              console.error(error);
            }
          });
        }
      };

    </script>

    <style>
      ::-webkit-scrollbar {
        width: 14px;
      }

      ::-webkit-scrollbar-track {
        box-shadow: inset 0 0 5px grey;
        border-radius: 8px;
      }

      ::-webkit-scrollbar-thumb {
        background: #31a4e1ff;
        border-radius: 8px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #1080bcff;
      }
    </style>
  </head>
  <body>

    <header>
    
      <!--nav begin-->
      <nav>
    
        <!--Beginning of Logo-->
        <a onclick="redirect('index.html')">
          <img class="logolight" src="https://verycoolmathgames.github.io/images/verycoolmathgameslogolight.jpg">
        </a>
        <!--End of Logo-->&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    
        <!--Beginning of Dropdown-->
        <div class="dropdown">
          <a class="dropbtn navelement" onclick="redirect('index.html')">Home</a>
        </div>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;
        <!--Beginning of Sign in button-->
        <div class="navelement" onclick="signIn()">Sign In</div>
        <script type="text/javascript">
        function signIn(){
          document.getElementById('popupsignin').style.display = "block";
        }
        </script>
        <!--End of Sign in button-->
      </nav>
      <!--nav end-->
    
    </header>
    
    <!--Popup-->
    <div id="popupsignin"class="signin demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">Sign In or Sign Up</h2>
            </div>
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
  
              <button class="signinoptions" onclick="email()">Email</button>
              <br><br>
              <button class="signinoptions" onclick="google()">Google</button>
              <br><br>
              <button class="signinoptions" onclick="close()">Close</button>
  
            </div>
          </div>
        </div>
      </main>
    </div>
    <!--Popup-->

  </body>
</html>
