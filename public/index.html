<html>
  <head>
    <title>Thx 4 Sharing</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" type="text/css" href="main.css">

    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase.js"></script>

    <script>
      firebase.initializeApp({
        apiKey: "AIzaSyBVT22t-x2H76119AHG8SgPU0_A0U-N1uA",
        authDomain: "my-scrap-project.firebaseapp.com",
        databaseURL: "https://my-scrap-project.firebaseio.com",
        projectId: "my-scrap-project",
        storageBucket: "my-scrap-project.appspot.com",
        messagingSenderId: "334998588870",
        appId: "1:334998588870:web:6b218e9655ade3a6c536c7",
        measurementId: "G-66W8QQ9W35"
      });

      var user = firebase.auth().currentUser;
      var db = firebase.firestore();
      db.enablePersistence();

      function redirect(pagePath) {
        if (pagePath === "signout") {
          firebase.auth().signOut();
          window.location.replace("https://www.thx4sharing.web.app");
        } else {
          //var urlParams = new URLSearchParams(window.location.search);
          //var mode = urlParams.get('mode').toString();
          window.location = pagePath;
        };
        open();
      };

      window.onload = function () {
        //var urlParams = new URLSearchParams(window.location.search);
        //var mode = urlParams.get("darkmode");
        //if (mode == "dark") {
        //  document.getElementByTagName("html").id = "dark";
        //}
      };
      
      // Email Login
      function displayName() {
        var uid = user.uid;
        var users = db.collection("users");
        users.doc(uid).get().then(function (doc) {
          var displayName = doc.data().displayName;
          return displayName;
        });
      };

      function eToggleSignIn() {
        
        var password = document.getElementById('password').value;
        var username = document.getElementById('username').value;
        if (username.length < 3) {
          alert('Please enter a longer username.');
          return;
        }
        if (password.length < 4) {
          alert('Please enter a longer password.');
          return;
        }

        var emails = db.collection("emails"); // firebase.firestore().collection("emails")
        var users = db.collection("users"); // firebase.firestore().collection("users")
        var userData = emails.doc(username); // firebase.firestore().collection("emails").doc(username)

        userData.get().then(function (doc) {
          if (doc.exists) {
            console.log("Document data:", doc.data());
            var email = doc.data().email;
            var uid = doc.data().uid;

            firebase.auth().signInWithEmailAndPassword(email, password)
              .then(function () {
                firebase.auth().onAuthStateChanged(function (user) {
                  window.location = "home.html?mode=light";
                });
              })
              .catch(function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                if (errorCode === 'auth/wrong-password') {
                  alert('Wrong password.');
                } else {
                  alert(errorMessage);
                }
                console.log(error);
              });
          } else {
            console.log("Document does not exist!");
            alert("User not found!");
          }
        }).catch(function (error) {
          console.log("Error getting document:", error);
        });
      };
      // Email Login End

      while(document.getElementById("email").style.display == "block") {
        document.addEventListener('keydown', function (event) {
          var password = document.getElementById('password').value;
          var username = document.getElementById('username').value;
          const key = event.key;
          if (key == "Enter") {
            eToggleSignIn();
          }
        });
      };

      // Google Login Begin
      function gToggleSignIn() {
        if (!firebase.auth().currentUser) {
          var provider = new firebase.auth.GoogleAuthProvider();

          firebase.auth().signInWithPopup(provider).then(function (result) {
            var token = result.credential.accessToken;
            var user = result.user;
            var uid = user.uid.toString();
            var db = firebase.firestore();
            var emails = db.collection("emails");
            var users = db.collection("users");

            firebase.auth().onAuthStateChanged(function (user) {
              if (user != null) {
                var user = firebase.auth().currentUser;

                user.providerData.forEach(function (profile) {
                  var username = profile.displayName.toString();
                  var email = profile.email.toString();
                  var userDataEmails = emails.doc(username);
                  var userDataUsers = users.doc(uid);

                  userDataEmails.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataEmails.set({
                        email: email,
                        uid: uid,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Emails doc already exists, skipped writing.");
                    }
                  });

                  userDataUsers.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataUsers.set({
                        displayName: username,
                        email: email,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Users doc already exists, skipped writing.");
                    }
                  });
                  window.location = "index.html?mode=light";
                });
              }
            })
          }).catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
            var email = error.email;
            var credential = error.credential;
            if (errorCode === 'auth/account-exists-with-different-credential') {
              alert('You have already signed up with a different method for that email. If you want to merge your Google account with an Email/Password account, go to the Account page.');
            } else {
              console.error(error);
            }
          });
        } else {
          firebase.auth().signOut();
          var provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().signInWithPopup(provider).then(function (result) {
            var token = result.credential.accessToken;
            var user = result.user;
            var uid = user.uid.toString();
            var db = firebase.firestore();
            var emails = db.collection("emails");
            var users = db.collection("users");

            firebase.auth().onAuthStateChanged(function (user) {
              if (user != null) {
                var user = firebase.auth().currentUser;

                user.providerData.forEach(function (profile) {
                  var username = profile.displayName.toString();
                  var email = profile.email.toString();
                  var userDataEmails = emails.doc(username);
                  var userDataUsers = users.doc(uid);

                  userDataEmails.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataEmails.set({
                        email: email,
                        uid: uid,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Emails doc already exists, skipped writing.");
                    }
                  });

                  userDataUsers.get().then(function (doc) {
                    if (!doc.exists) {
                      userDataUsers.set({
                        displayName: username,
                        email: email,
                      }).then(function () {
                        console.log("Document successfully written!");
                      }).catch(function (error) {
                        console.error("Error writing document: ", error);
                      });
                    } else {
                      console.log("Users doc already exists, skipped writing.");
                    }
                  });
                  window.location = "index.html?mode=light";
                });
              }
            })
          }).catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
            var email = error.email;
            var credential = error.credential;
            if (errorCode === 'auth/account-exists-with-different-credential') {
              alert('You have already signed up with a different method for that email. If you want to merge your Google account with an Email/Password account, go to the Account page.');
            } else {
              console.error(error);
            }
          });
        }
      };
      // Google Login End
      
    </script>
  </head>
  <body>

    <header>
      <!--nav begin-->
      <nav>

        <!--Beginning of Logo-->
          <a onclick="redirect('index.html')">Logo Here</a>
        <!--End of Logo-->&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    
        <!--Beginning of Dropdown-->
          <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Home</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;

        <!--Beginning of Dropdown-->
         <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Products</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;

        <!--Beginning of Dropdown-->
         <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Shopping Cart</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;
         
        <!--Beginning of Dropdown-->
          <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Check Out</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;

        <!--Beginning of Dropdown-->
          <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Locations</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;
        
        <!--Beginning of Dropdown-->
          <a id="home" class="navelement dropbtn" onclick="redirect('index.html')">Contact Info</a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;
        
        <!--Beginning of Dropdown-->
          <a id="home" class="navelement dropbtn">
            <div class=" search mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right">
              <label class="mdl-button mdl-js-button mdl-button--icon" for="waterfall-exp">
                <i class="material-icons">Search</i>
              </label>
              <div class="mdl-textfield__expandable-holder">
                <input class="mdl-textfield__input" type="text" name="sample" id="waterfall-exp">
              </div>
            </div>
          </a>
        <!--End of Dropdown-->&nbsp;&nbsp;&nbsp;
        
        <!--Beginning of Sign in button-->
          <a id="signin" class="navelement" onclick="signIn()">Sign In</a>
        <!--End of Sign in button-->

        <!--Sign in Element Scripts-->
          <script type="text/javascript">
            function signIn() {
              document.getElementById('popupsignin').style.display = "block";
            };
            function close(elem) {
              document.getElementById(elem).style.display = "none";
            };
          </script>
        <!--End of script-->

      </nav>
      <!--nav end-->
    </header>
    
    <!--Popup-->
    <div id="popupsignin" class="signin demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">

            <div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text">Sign In or Sign Up</h2>
            </div>

            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <button class="signinoptions" onclick="eToggleSignIn()">Email</button>
              <br><br>
              <button class="signinoptions" onclick="gToggleSignIn()">Google</button>
              <br><br>
              <button class="signinoptions" onclick="redirect('signUp')">Sign Up</button>
              <br><br>
              <button class="signinoptions" onclick="close('popupsignin')">Close</button>
            </div>

          </div>
        </div>
      </main>
    </div>
    <!--Popup-->

    <!--Email Popup-->
    <div id="email" class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
    
          <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
    
              <p>Enter an email and password below to sign in.</p>
    
              <input class="mdl-textfield__input" style="display:inline;" type="text" id="username" name="username" placeholder="Username" />
              &nbsp;&nbsp;&nbsp;
              <input class="mdl-textfield__input" style="display:inline;" type="password" id="password" name="password" placeholder="Password" />
              <br/><br/>

              <button class="mdl-button mdl-js-button mdl-button--raised" onclick="toggleSignIn()" name="signin">Sign In</button>
              &nbsp;&nbsp;&nbsp;

              <button class="mdl-button mdl-js-button mdl-button--raised" onclick="redirect('passwordReset')">Send Password Reset Email</button>
    
              <p>
                <li>
                  <a onclick="close(email)">Close</a>
                </li>
              </p>
    
            </div>
          </div>
        </div>
      </main>
    </div>

  </body>
</html>